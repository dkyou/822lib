# 课程3 脉宽调制原理及应用
## 课程概述 
在这个教程中，我们将学习如何用树莓派上的GPIO控制LED灯呼吸。
## 关于课程
按照规划，本课程需要花费大约60分钟来完成，目标受众为四足机器人开发爱好者。
**note**
本课程是基于[Mangdang](https://www.mangdang.net/)的Mini Pupper系列产品搭建的。
本课程涉及的源代码托管在Github，你可以[点击此处访问](https://github.com/mangdangroboticsclub/mini_pupper_ros/tree/ros2)。
## 学习目标
在完成这个教程后，你将能够：
1. 通过背景知识学习，了解digital与analog的区别。
2. 通过GPIO对外部LED灯进行呼吸控制，熟悉PWM技术。

课程细节
----

本课程将使用以下组件：

*   树莓派
*   LED模块
*   杜邦线

这个教程分为以下任务：

1.  学习实验知识
2.  硬件连接
3.  编写Python程序 led_breathe.py
4.  运行程序，观察效果

准备材料
----

在开始这个教程之前，你需要准备以下材料：

*   一台树莓派
*   一个LED模块
*   几根杜邦线

# 引言
在这个教程中，我们将学习如何通过python编程，用GPIO控制LED灯，使之亮度逐渐增大，随后减小，并循环上述过程，实现呼吸效果，周期为4s。
## 整体步骤
这个教程将分为几个任务：
1.学习实验知识
2.编写Python程序led_breathe.py
3.运行程序，观察实验效果

请按照教程中的步骤完成每个任务。
# 任务1：学习实验知识

1.pwm前置知识

单片机的IO口输出的是**数字信号**，**IO口只能输出高电平和低电平**

假设高电平为5V 低电平则为0V 那么我们要**输出不同的模拟电压**，就要用到PWM，通过改变IO口输出的**方波的占空比**从而获得使用数字信号模拟成的模拟电压信号

比方说 占空比为50% 那就是高电平时间一半，低电平时间一半，在一定的频率下，就可以得到模拟的2.5V输出电压 那么75%的占空比 得到的电压就是3.75V

![PWM1](.\pic\PWM1.png)

2.使用PWM实现呼吸灯效果

呼吸灯现象解释：**一般人眼睛对于100Hz 以上刷新频率则完全没有闪烁感。**

那么我们平时见到的LED灯，当它的频率大于50Hz的时候，人眼就会产生视觉暂留效果，基本就看不到闪烁了，而是一个常亮的LED灯，

你在1秒内，高电平0.5秒，低电平0.5秒，(频率1Hz)如此反复，那么你看到的电灯就会闪烁，但是如果是10毫秒内，5毫秒打开，5毫秒关闭，(频率100Hz) 这时候灯光的亮灭速度赶不上开关速度(LED灯还没完全亮就又熄灭了)，由于视觉暂留作用 人眼不感觉电灯在闪烁，而是感觉灯的亮度少了 因为高电平时间(占空比)为50% 亮度也就为之前的50% 。

**频率很高时，看不到闪烁，占空比越大，LED越亮；
频率很低时，可看到闪烁，占空比越大，LED越亮。**

因此：

在频率一定下，可以用不同占空比改变LED灯的亮度。 使其达到一个呼吸灯的效果

3.使用PWM实现舵机控制

占空比可以实现对电机转速的调节，占空比是高电平在一个周期之中的比值，高电平的所占的比值越大，占空比就越大，对于直流电机来讲，电机输出端引脚是高电平电机就可以转动，当输出端高电平时，电机会转动，但是是一点一点的提速，在高电平突然转向低电平时，电机由于电感有防止电流突变的作用是不会停止的，会保持这原有的转速，以此往复，电机的转速就是周期内输出的平均电压值，所以实质上我们调速是将电机处于一种，似停非停，似全速转动又非全速转动的状态，那么在一个周期的平均速度就是我们占空比调出来的速度。



舵机的控制就是通过一个固定的频率，给其不同的占空比的，来控制舵机不同的转角

舵机的频率一般为频率为50HZ，也就是一个20ms左右的时基脉冲，而脉冲的高电平部分一般为0.5ms-2.5ms范围。来控制舵机不同的转角



4.pwm重要参数

pwm的频率：是指1秒钟内信号从高电平到低电平再回到高电平的次数(一个周期)，单位HZ，周期的倒数

占空比：是一个脉冲周期内，高电平的时间与整个周期时间的比例

![PWM1](.\pic\PWM2.png)



### 7. RPi的GPIO库中PWM的用法

### 1. 查看树莓派GPIO引脚图

```bash
pinout
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/cfc05d828b3b4b5a959c3f23516722a7.png)**图片1：GPIO引脚图**

[参考链接：树莓派官方4B引脚图的详细资料](https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#gpio-and-the-40-pin-header)
### 2.安装及引入RPi.GPIO库

```bash
sudo pip install RPi.GPIO # 命令行pip安装RPi.GPIO
```
```python
import RPi.GPIO as GPIO # 在Python代码引入RPi.GPIO库
```
### 3. RPi.GPIO库的用法
```python
GPIO.setmode(GPIO.BOARD) #初始化GPIO引脚编码方式，需放在代码正式开始处
# GPIO引脚由多种编码方式，比如BCM、wiringPi、BOARD等,方便起见，课程均采用BOARD编码模式
```

```python
GPIO.setup(12, GPIO.OUT) #初始化GPIO引脚设置，需放在代码正式开始处
GPIO.setup(12, GPIO.IN) #12为引脚号 GPIO.IN或者GPIO.OU为输入输出模式
```

```python
print(GPIO.input(12)) #GPIO.input查看GPIO输入的电平信号
#GPIO.HIGH为高电平 ，GPIO.LOW为低电平 也可用于条件判断作其他操作
```

```python
# GPIO.output向端口发送高低电平信号
GPIO.output(12, GPIO.HIGH) # 此处以12号端口为例
GPIO.output(12, GPIO.LOW)
```

```python
GPIO.cleanup() #在使用完GPIO后要作清理，避免后续引脚被占用
```
[参考链接：Python RPi.GPIO库官方文档](https://pypi.org/project/RPi.GPIO/)

### 


```python
import RPi.GPIO as GPIO	#	引入GPIO库
```
```python
GPIO.setmode(GPIO.BOARD) #初始化GPIO引脚编码方式，需放在代码正式开始处
GPIO.setup(12, GPIO.OUT) #初始化GPIO引脚设置，需放在代码正式开始处
```
```python
p = GPIO.PWM(channel, frequency)	#	创建pwm实例 channel为引脚号 frequency为频率
```

```python
p.start(dc)	#	开始pwm	dc为初始占空比(0.0 <= dc <= 100.0)
```

```python
p.stop() # 停止pwm
```

```python
p.ChangeFrequency(freq)   # 改变频率（Hz）freq
```

```python
p.ChangeDutyCycle(dc)  # 改变占空比(0.0 <= dc <= 100.0)
```



```python
GPIO.cleanup() # 清理GPIO引脚
```

[参考链接：RPi GPIO库中PWM()函数的详细资料](https://sourceforge.net/p/raspberry-gpio-python/wiki/PWM/)

### 8.mini pupper学习套件-LED模块的使用
mini pupper学习套件中的LED模块自带板载限流电阻，能够保护LED模块。
接线如下：

|引脚|作用|树莓派对应口|
|--|--|--|
| GND |接地 |GND口|
| R |红灯正极 |PWM口|
| G |绿灯正极 |PWM口|
| B |蓝灯正极 |PWM口|

![在这里插入图片描述](https://img-blog.csdnimg.cn/7e7d8863c69341cdb417a90dc8f0bfcf.jpeg)

**图片2：树莓派LED灯细节图**
# 任务2：编写Python程序led_breathe.py

```python
#!/usr/bin/python
# coding:utf-8
# led_breathe.py
# 树莓派GPIO控制外部LED灯呼吸，周期为4秒。
import time
import RPi.GPIO as GPIO

# GPIO初始化
LED = 33    # 外部led灯连接的树莓派PWM端口，可根据需要调整
GND = 34    # 接地的端口
period = 4  # 呼吸周期
GPIO.setmode(GPIO.BOARD)
GPIO.setup(LED, GPIO.OUT)
p = GPIO.PWM(LED, 50)  # 引脚=LED 频率=50Hz
p.start(0)
print("PWM控制呼吸灯开始，端口号为%d，周期为%d秒。" % (LED, period))
try:    # try和except为固定搭配，用于捕捉执行过程中，用户是否按下ctrl+C终止程序
    while 1:
        for dc in range(0, 101, 1):
            p.ChangeDutyCycle(dc)
            time.sleep(period / 200)
        for dc in range(100, -1, -1):
            p.ChangeDutyCycle(dc)
            time.sleep(period / 200)
except KeyboardInterrupt:
    pass
p.stop()
GPIO.cleanup()
```
# 任务3：运行程序，观察实验效果
在led_breathe.py的目录下执行以下命令：
```bash
sudo python3 led_breathe.py
```
应该能观察到用LED灯亮度逐渐增大，随后减小，并循环上述过程，体现了呼吸的效果，周期为4s。
# 总结

经过本知识点的学习和实验操作，你应该能达到以下水平：
| 知识点 | 内容 | 了解|熟悉|掌握|
|--|--|--|--|--|
模拟与数字|模拟与数字的区别|&#10004;|||
树莓派|树莓派GPIO中的PWM端口|&#10004;|||
PWM|PWM技术的用法||&#10004;||
硬件|mini pupper学习套件的LED模块的使用|||&#10004;|
# 背景信息和资源
本教程基于以下资源编写：
[参考链接：树莓派官方4B引脚图的详细资料](https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#gpio-and-the-40-pin-header)
[参考链接：Python RPi.GPIO库官方文档](https://pypi.org/project/RPi.GPIO/)
[参考链接：RPi GPIO库中PWM()函数的详细资料](https://sourceforge.net/p/raspberry-gpio-python/wiki/PWM/)

**版权信息：教材尚未完善，此处预留版权信息处理方式**
mini pupper相关内容可访问：[https://github.com/mangdangroboticsclub](https://github.com/mangdangroboticsclub)


