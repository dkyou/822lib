# 课程4 机器人的运动关节单元控制
## 课程概述 
在这个教程中，我们将学通过习树莓派GPIO控制外部舵机。
## 关于课程
按照规划，本课程需要花费大约60分钟来完成，目标受众为四足机器人开发爱好者。
**note**
本课程是基于[Mangdang](https://www.mangdang.net/)的Mini Pupper系列产品搭建的。
本课程涉及的源代码托管在Github，你可以[点击此处访问](https://github.com/mangdangroboticsclub/mini_pupper_ros/tree/ros2)。
## 学习目标
在完成这个教程后，你将能够：
1. 通过背景知识学习，了解舵机的外观及基本运动方式。
2. 了解四足机器人mini pupper腿部单个舵机的组成结构。
3. 通过GPIO对舵机进行转动控制，熟悉PWM。
4. 了解mini pupper舵机组的整体调零。

## 课程细节
本课程将使用树莓派GPIO控制Mangdang定制舵机。

## 准备材料
在开始这个教程之前，你需要准备以下材料：
- 一台安装了Python的树莓派4B
- Mangdang定制舵机
- 若干杜邦线
# 引言
在这个教程中，我们将学习如何使用Python语言编程，在编程中使用PWM方法，通过树莓派GPIO控制外部舵机来回摆动，角度范围为0°~180°，周期为四秒。
## 整体步骤
这个教程将分为几个任务：
1.学习基本知识
2.编写Python程序 servo_PWM_GPIO.py
3.运行程序servo_PWM_GPIO.py并观察效果
4. 尝试运行Python程序 servo_PWM_GPIO_2.py[可选]

请按照教程中的步骤完成每个任务。
# 任务1：学习基本知识
### 1. 什么是舵机？
舵机（servomotor）是一种简化版本的伺服电机，是位置伺服的驱动器，能够通过输入PWM信号控制旋转角度，具备轻量、小型、简化和性价比高的特点。
舵机适用于那些需要角度不断变化并可以保持的简单控制系统，它能实现较为精确的电机控制，在航模、遥控玩具、机器狗等品类上运用良好。
![在这里插入图片描述](https://img-blog.csdnimg.cn/88635d9bc7174ea4bde6b0e04adb5dd4.jpeg)


**图片1：舵机的外观**
### 2. 舵机的运动方式
舵机的运动方式是绕轴摆动，“舵机”一词也和它的运动方式有关，舵机常用来摆动调整方向，就像海洋上的水手的舵一样，航模和船模常常用舵机的摆动来调整一些零部件的角度。

**图片2：舵机的运动动图**

### 3. 舵机的组成结构
舵机一般是由保护外壳、内部集成控制芯片、小型直流电机、减速器齿轮组、位置检测单元构成的。

当主控给舵机发出转动信号时，控制芯片驱动电机开始转动，通过减速器将动力传达到输出轴上的摆臂，由位置检测单元反馈转动结果信号给主控进行反馈调节。
一般来说，位置检测单元可以是可变电阻，当舵机转动时，可变电阻随之改变，由此可得转动的角度信息。舵机包含了电机、传感器和控制器，是一个集成度高的、完整的伺服电机系统。
![在这里插入图片描述](https://img-blog.csdnimg.cn/fd87bfa9017a4152b5b84c436153ae9d.jpeg)


**图片2：舵机的内部结构拍摄**



### 4. mini pupper定制舵机的部分硬件参数
芒砀科技MANGDANG针对mini pupper的运动需求，在原型舵机的基础上优化改进了机械结构，定制了mini pupper专用舵机，这使得mini pupper的控制更加精确、动力更加澎湃。
![在这里插入图片描述](https://img-blog.csdnimg.cn/8f0f387baf1e40ebb1289070ae5377f2.png)
**图片3：Mangdang定制舵机**



**参考文件：mini pupper定制电机规格书 课程附件 MiniPupper-Servo-Spec.pdf**
你可以在课程附件里找到这个规格书
### 5.mini pupper舵机的控制方法
对于舵机的控制，首先要了解其基本硬件参数以及舵机对信号通讯的要求。
如图所示，mini pupper一代舵机允许PWM的直接使用，也就是说，舵机可以直接连接到树莓派上的GPIO_PWM端口使用而不需要考虑通讯协议，这对机器人入门开发者来说较为友好。

```bash
servo_SIG = 32  # 1
servo_VCC = 4  # 2
servo_GND = 6  # 3
# 1,2,3 in picture below
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/7345348c27aa4cd481d70d7c3fda2e17.png)
**图片4：舵机端口的连线**

#### mini pupper一代舵机部分参数表
|name|value  |
|--|--|
| 端口1(黄) |  PWM Signal|
| 端口2(红)|  Vcc 4.8v~6v|
| 端口3 (棕)|  GND|
| 信号周期 |  20ms|
| 信号频率 | 50HZ|
| 脉冲长度范围 |500us-2500us to 0°~180°|
| 脉冲长度对应占空比| 2.5% - 12.5%  |
| 信号高电平范围|  2V-5V|
| 信号低电平范围|  0.0V-0.45V|
| 中间位对应脉冲|  1500 μsec|

需要注意的是：
占空比=脉宽/周期
脉宽500us-2500us对应的占空比为2.5% - 12.5%  

这里涉及到将角度0-180°线性映射到占空比2.5% - 12.5%  ，公式如下：

![servo](.\pic\servo.png)

### 6. RPi的GPIO库中PWM的用法


```python
import RPi.GPIO as GPIO	#	引入GPIO库
```
```python
GPIO.setmode(GPIO.BOARD) #初始化GPIO引脚编码方式，需放在代码正式开始处
GPIO.setup(12, GPIO.OUT) #初始化GPIO引脚设置，需放在代码正式开始处
```
```python
p = GPIO.PWM(channel, frequency)	#	创建pwm实例 channel为引脚号 frequency为频率
```

```python
p.start(dc)	#	开始pwm	dc为初始占空比(0.0 <= dc <= 100.0)
```

```python
p.stop() # 停止pwm
```

```python
p.ChangeFrequency(freq)   # 改变频率（Hz）freq
```

```python
p.ChangeDutyCycle(dc)  # 改变占空比(0.0 <= dc <= 100.0)
```



```python
GPIO.cleanup() # 清理GPIO引脚
```
[参考链接：RPi GPIO库中PWM()函数的详细资料](https://sourceforge.net/p/raspberry-gpio-python/wiki/PWM/)
# 任务2：编写Python程序 servo_PWM_GPIO.py
```python
#!/usr/bin/python
# coding:utf-8
# servo_PWM_GPIO.py
# 树莓派GPIO控制外部舵机来回摆动，角度范围为0~180°，周期为4秒。
try:
    import RPi.GPIO as GPIO
except RuntimeError:
    print("Error importing RPi.GPIO!  This is probably because you need superuser privileges. "
          " You can achieve this by using 'sudo' to run your script")
import time


def servo_map(before_value, before_range_min, before_range_max, after_range_min, after_range_max):
    """
    功能:将某个范围的值映射为另一个范围的值
    参数：原范围某值，原范围最小值，原范围最大值，变换后范围最小值，变换后范围最大值
    返回：变换后范围对应某值
    """
    percent = (before_value - before_range_min) / (before_range_max - before_range_min)
    after_value = after_range_min + percent * (after_range_max - after_range_min)
    return after_value


GPIO.setmode(GPIO.BOARD)  # 初始化GPIO引脚编码方式
servo_SIG = 32
servo_VCC = 4
servo_GND = 6
servo_freq = 50
servo_time = 0.01
servo_width_min = 2.5
servo_width_max = 12.5
# servo_degree_div =servo_width_max - servo_width_min)/180
GPIO.setup(servo_SIG, GPIO.OUT)
# 如果你需要忽视引脚复用警告，请调用GPIO.setwarnings(False)
# GPIO.setwarnings(False)
servo = GPIO.PWM(servo_SIG, servo_freq)  # 信号引脚=servo_SIG 频率=servo_freq in HZ
servo.start(0)
servo.ChangeDutyCycle((servo_width_min+servo_width_max)/2)  # 回归舵机中位
print('预设置完成，两秒后开始摆动')
time.sleep(2)
try:  # try和except为固定搭配，用于捕捉执行过程中，用户是否按下ctrl+C终止程序
    while 1:
        for dc in range(1, 181, 1):
            dc_trans = servo_map(dc, 0, 180, servo_width_min, servo_width_max)
            servo.ChangeDutyCycle(dc_trans)
            # print(dc_trans)
            time.sleep(servo_time)
        time.sleep(0.2)
        for dc in range(180, -1, -1):
            dc_trans = servo_map(dc, 0, 180, servo_width_min, servo_width_max)
            servo.ChangeDutyCycle(dc_trans)
            # print(dc_trans)
            time.sleep(servo_time)
        time.sleep(0.2)
except KeyboardInterrupt:
    pass
servo.stop()  # 停止pwm
GPIO.cleanup()  # 清理GPIO引脚
```



# 任务3：运行程序servo_PWM_GPIO.py并观察效果

在servo_PWM_GPIO.py的目录下执行以下命令：
```bash
sudo python servo_PWM_GPIO.py
```
此时应观察到舵机在树莓派的控制下来回摆动，角度范围为0°~180°，周期为四秒。

# 任务4：尝试运行Python程序 servo_PWM_GPIO_2.py[可选]

```python
#!/usr/bin/python
# coding:utf-8
# servo_PWM_GPIO_2.py
# 输入一个角度值，舵机将转动到对应的角度
try:
    import RPi.GPIO as GPIO
except RuntimeError:
    print("Error importing RPi.GPIO!  This is probably because you need superuser privileges. "
          " You can achieve this by using 'sudo' to run your script")
import time


def servo_map(before_value, before_range_min, before_range_max, after_range_min, after_range_max):
    """
    功能:将某个范围的值映射为另一个范围的值
    参数：原范围某值，原范围最小值，原范围最大值，变换后范围最小值，变换后范围最大值
    返回：变换后范围对应某值
    """
    percent = (before_value - before_range_min) / (before_range_max - before_range_min)
    after_value = after_range_min + percent * (after_range_max - after_range_min)
    return after_value


GPIO.setmode(GPIO.BOARD)  # 初始化GPIO引脚编码方式
servo_SIG = 32
servo_VCC = 4
servo_GND = 6
servo_freq = 50
servo_time = 0.01
servo_width_min = 2.5
servo_width_max = 12.5
# servo_degree_div =servo_width_max - servo_width_min)/180
GPIO.setup(servo_SIG, GPIO.OUT)
# 如果你需要忽视引脚复用警告，请调用GPIO.setwarnings(False)
# GPIO.setwarnings(False)
servo = GPIO.PWM(servo_SIG, servo_freq)  # 信号引脚=servo_SIG 频率=servo_freq in HZ
servo.start(0)
servo.ChangeDutyCycle((servo_width_min+servo_width_max)/2)  # 回归舵机中位
print('预设置完成，两秒后开始等待输入')
time.sleep(2)
# 为舵机指定位置
try:    # try和except为固定搭配，用于捕捉执行过程中，用户是否按下ctrl+C终止程序
    while 1:
        position = input("请输入0°-180°的角度值：\n")
        if position.isdigit()==1:
            dc = int(position)
            if (dc>=0) and (dc<=180):
                dc_trans=servo_map(dc, 0, 180,servo_width_min,servo_width_max)
                servo.ChangeDutyCycle(dc_trans)
                print("已转动到%d°处"%dc)
            else:
                print("Error Input:Exceed Range")
        else:
            print("Error Input:Not Int Input")
except KeyboardInterrupt:
    pass

servo.stop()  # 停止pwm
GPIO.cleanup()  # 清理GPIO引脚
```
## 尝试整机调零[可选]
为了确保控制精度，mini pupper上的舵机组通常在使用前先进行一次调零。
在安装好mini_pupper_bsp包后，试试在命令行中运行图形化舵机调零程序calibrate

```bash
calibrate  # this is a command
```
如果希望了解校准的详细信息，你可以查看[mini pupper的官方文档：校准](https://minipupperdocs.readthedocs.io/en/latest/guide/Software.html#step-2-1-leg-calibration-not-for-ros-image)

确保 Mini Pupper 已预先组装好，使用GUI校准工具来优化腿部的位置。
对于每条腿，移动杆，使所有腿都成 45 度角。 腿的角度会随着滑动条在屏幕上的位置而变化。 
如果它不动，则说明您执行的步骤不正确。
您可以使用 iPhone 的倾斜传感器app、尺子或量角器来测量角度。
# 总结

经过本知识点的学习和实验操作，你应该能达到以下水平：

| 知识点 | 内容 | 了解|熟悉|掌握|
|--|--|--|--|--|
舵机|舵机的外观及基本运动方式|&#10004;|||
舵机|单个舵机的组成结构|&#10004;|||
PWM|PWM方法对舵机进行转动控制||&#10004;||
调零与校准|mini pupper舵机组的调零与校准|&#10004;|||
# 背景信息和资源
本教程基于以下资源编写：
[参考链接：RPi GPIO库中PWM()函数的详细资料](https://sourceforge.net/p/raspberry-gpio-python/wiki/PWM/)
[参考链接：mini pupper的官方文档：校准](https://minipupperdocs.readthedocs.io/en/latest/guide/Software.html#step-2-1-leg-calibration-not-for-ros-image)

**版权信息：教材尚未完善，此处预留版权信息处理方式**
mini pupper相关内容可访问：[https://github.com/mangdangroboticsclub](https://github.com/mangdangroboticsclub)


