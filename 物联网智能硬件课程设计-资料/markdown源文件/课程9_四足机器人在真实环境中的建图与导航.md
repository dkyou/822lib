# 课程9 四足机器人在真实环境中的建图与导航

## 课程概述
在这个教程中，我们将学习如何来控制实际环境中的Mini Pupper，完成SLAM（Simultaneous Localization and Mapping，同时定位和建图）和导航任务。这个教程将指导你一步步地完成配置、控制、SLAM和导航任务。

  - 演示1：键盘控制真实世界中的Mini Pupper
![请添加图片描述](https://img-blog.csdnimg.cn/7d63f71cd0e942e2bd8c85438b26c691.gif)

  - 演示2：键盘控制Mini Pupper完成SLAM
 ![请添加图片描述](https://img-blog.csdnimg.cn/d90a084ee8d34a33a0c60fe550fc6998.gif)


  - 演示3：Mini Pupper的Navigation
 ![请添加图片描述](https://img-blog.csdnimg.cn/aa972addd02844b38f91f5737080a2b4.gif)

## 关于课程 
按照规划，本课程需要花费大约2小时来完成，目标受众为四足机器人开发爱好者。
**note**
本课程是基于[Mangdang](https://www.mangdang.net/)的Mini Pupper系列产品搭建的。
本课程涉及的源代码托管在Github，你可以[点击此处访问](https://github.com/mangdangroboticsclub/mini_pupper_ros/tree/ros2)。
## 学习目标


在完成这个教程后，你将能够：

1.  配置你的PC和Mini Pupper的环境。
2.  用键盘控制实际环境中的Mini Pupper。
3.  让Mini Pupper在实际环境中完成SLAM。
4.  让Mini Pupper在实际环境中进行导航。

## 课程细节

本课程将使用以下组件：
 - [Ubuntu](https://ubuntu.com/)是一个以桌面应用为主的Linux操作系统，具有良好的版本维护和社区环境
 - [ROS](https://www.ros.org/)是一个机器人通用的开发的平台，可帮助您方便地构建机器人应用程序
 - [Rviz](http://wiki.ros.org/rviz/UserGuide)是ROS体系下的 3D 数据可视化工具
 
这个教程分为四个任务：

1.  配置环境
2.  用键盘控制真实世界的Mini Pupper
3.  Mini Pupper在真实世界的SLAM
4.  Mini Pupper在真实世界的导航

每个任务都有详细的步骤指导，你可以按照步骤完成课程。

## 准备材料


在开始这个教程之前，你需要准备以下材料：

1.  一台装有Ubuntu 22.04和ROS2 Humble的PC。
2.  一个真实环境的Mini Pupper，装有和Ubuntu 22.04以及ROS2 Humble。
3.  确保你的PC和Mini Pupper连接到同一个局域网并关闭防火墙功能。

# 引言


在这个教程中，我们将学习如何使用ROS2来控制实际环境中的Mini Pupper，完成SLAM和导航任务。首先，我们需要配置我们的环境，然后我们将学习如何用键盘控制Mini Pupper。接下来，我们将让Mini Pupper在实际环境中完成SLAM任务，最后，我们将实现Mini Pupper的导航功能。

## 整体步骤


这个教程将分为四个任务：

1.  [配置环境](#step1)
2.  [用键盘控制真实世界的Mini Pupper](#step2)
3.  [Mini Pupper在真实世界的SLAM](#step3)
4.  [Mini Pupper在真实世界的导航](#step4)

请按照教程中的步骤完成每个任务。

<span id="step1"></span>

# 任务1：配置环境


在开始控制Mini Pupper之前，我们需要确保我们的环境已经配置好。这个任务包括两个步骤：

## 第一步：配置PC
PC Setup corresponds to PC (your desktop or laptop PC) for controlling Mini Pupper remotely or executing the simulator.

### 1.1 ROS 2 installation
Please follow the [installation document for ROS Humble](https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html) or use the [unofficial ROS 2 installation script](https://github.com/Tiryoh/ros2_setup_scripts_ubuntu).

### 1.2 Download the Mini Pupper ROS 2 & dependencies packages
After ROS 2 installation, download the Mini Pupper ROS package in the workspace.
```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src
git clone https://github.com/mangdangroboticsclub/mini_pupper_ros.git -b ros2
vcs import < mini_pupper_ros/.minipupper.repos --recursive  # requires vcstool
```
**Notes:**
If you haven't installed vcstool, please install vcstool first.
```bash
sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
sudo apt install curl # if you haven't already installed curl
curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install python3-vcstool
```
### 1.3 Build and install all ROS packages
```bash
cd ~/ros2_ws
rosdep install --from-paths src --ignore-src -r -y
sudo apt-get install ros-humble-teleop-twist-keyboard
pip install transforms3d
colcon build --symlink-install
```
## 第二步：配置Mini Pupper
Mini Pupper Setup corresponds to the Raspberry Pi on your Mini Pupper.
### 2.1 mini_pupper_bsp installation
You should first install dependencies of servos, battery monitor, and display screen.  
See [mini_pupper_bsp](https://github.com/mangdangroboticsclub/mini_pupper_bsp).

### 2.2 ROS 2 installation
After installing the driver software, install ROS 2. ROS 2 Humble is required.  
Please follow the [installation document for ROS Humble](https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html) or use the [unofficial ROS 2 installation script](https://github.com/Tiryoh/ros2_setup_scripts_ubuntu).

### 2.3  Download the Mini Pupper ROS 2 & dependencies packages
After ROS 2 installation, download the Mini Pupper ROS package in the workspace.

```bash
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws/src
git clone https://github.com/mangdangroboticsclub/mini_pupper_ros.git -b ros2
vcs import < mini_pupper_ros/.minipupper.repos --recursive  # requires vcstool
# compiling the gazebo and cartographer on Raspberry Pi is not recommended
touch mini_pupper_ros/mini_pupper_gazebo/AMENT_IGNORE
touch mini_pupper_ros/mini_pupper_navigation/AMENT_IGNORE
```
**Notes:**                                             
If you haven't installed vcstool, please install vcstool first.
```bash
sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
sudo apt install curl # if you haven't already installed curl
curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install python3-vcstool
```
 
### 2.4 Build and install all ROS packages


```bash
# install dependencies without unused heavy packages
cd ~/ros2_ws
rosdep install --from-paths src --ignore-src -r -y --skip-keys=joint_state_publisher_gui --skip-keys=rviz2 --skip-keys=gazebo_plugins --skip-keys=velodyne_gazebo_plugins
sudo apt-get install ros-humble-teleop-twist-keyboard
pip install transforms3d
colcon build --symlink-install
```
**Tips:**
```bash
# If the Raspberry Pi has less than 4GB memory, please try
MAKEFLAGS=-j1 colcon build --executor sequential --symlink-install
# instead of `colcon build --symlink-install`
```

<span id="step2"></span>

# 任务2：用键盘控制真实世界的Mini Pupper

在这个任务中，我们将学习如何用键盘控制真实世界中的Mini Pupper。这个任务包括五个步骤：

## 第一步：检查PC和Mini Pupper上的Ubuntu22.04和ROS2 Humble的环境配置
确保你已经完成了任务1中的两个步骤，配置好了PC和Mini Pupper的环境。

## 第二步：SSH登录Mini Pupper
在你的PC上打开一个终端，并通过SSH登录到Mini Pupper。首先需要获取你的MiniPupper的机器名和IP地址。
### 2.1 获取机器名
为Mini Pupper连接显示屏，打开终端，查看机器名。
如图2.2.1中所示的"mangdang"即为这台机器的机器名。

![请添加图片描述](https://img-blog.csdnimg.cn/8a51a66a7e274f77a091aee2c250f376.jpeg)

### 2.2 获取IP地址
查看这台Mini Pupper的IP地址。
在命令行中输入
```bash
ifconfig
```
如图2.2.1中所示的192.168.50.13即为本机的IP地址。
![在这里插入图片描述](https://img-blog.csdnimg.cn/92a31aa8d7d94b17bd84bea64d3a28f0.png)

### 2.3 SSH登录
```bash
ssh username@mini-pupper-ip-address
```

请将`username`和`mini-pupper-ip-address`替换为实际的用户名和IP地址。
例如：
```bash
ssh mangdang@192.168.50.13
```


## 第三步：SSH启动Mini Pupper的bringup


在通过SSH登录到Mini Pupper的终端中，执行以下命令启动bringup：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_bringup bringup.launch.py
```

这将启动Mini Pupper上的所有必要节点。
成功启动的节点应当没有任何报错信息，如图2.3.1和2.3.2，请查看你的命令行窗口内容。
![请添加图片描述](https://img-blog.csdnimg.cn/59153ecf8df644b997f2d9d68d9838fb.jpeg)


![请添加图片描述](https://img-blog.csdnimg.cn/fc94556de1df4cc68776988886417bd6.png)


## 第四步：在PC上启动Mini Pupper的键盘控制节点


在你的PC上打开另一个终端，并执行以下命令启动键盘控制节点：

```bash
ros2 run teleop_twist_keyboard teleop_twist_keyboard
```
![请添加图片描述](https://img-blog.csdnimg.cn/bc716565b1804a8ca04e3ed2b9597667.png)

## 第五步：通过键盘控制真实世界的Mini Pupper

按照teleop\_twist\_keyboard节点的提示，使用键盘控制Mini Pupper。尝试让Mini Pupper前进、后退、左右转和停止。熟悉Mini Pupper的控制方式。
![请添加图片描述](https://img-blog.csdnimg.cn/7d63f71cd0e942e2bd8c85438b26c691.gif)
因为Mini Pupper的小体积，它无法以非常快的速度移动，你可以在Keyboard节点为Mini Pupper确定一个更小的移动速度。

<span id="step3"></span>

# 任务3：Mini Pupper在真实世界的SLAM


在这个任务中，我们将学习如何让Mini Pupper在真实世界中完成SLAM。这个任务包括七个步骤：

## 第一步：检查PC和Mini Pupper上的Ubuntu22.04和ROS2 Humble的环境配置


确保你已经完成了任务1中的两个步骤，配置好了PC和Mini Pupper的环境。

## 第二步：SSH登录Mini Pupper


在你的PC上打开一个终端，并通过SSH登录到Mini Pupper。例如：

```bash
ssh username@mini-pupper-ip-address
```

请将`username`和`mini-pupper-ip-address`替换为实际的用户名和IP地址。

## 第三步：SSH启动Mini Pupper的bringup


在通过SSH登录到Mini Pupper的终端中，执行以下命令启动bringup：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_bringup bringup.launch.py
```

这将启动Mini Pupper上的所有必要节点。

## 第四步：在PC上启动Mini Pupper的键盘控制节点


在你的PC上打开另一个终端，并执行以下命令启动键盘控制节点：

```bash
ros2 run teleop_twist_keyboard teleop_twist_keyboard
```

现在你可以使用键盘控制Mini Pupper。

## 第五步：在PC上启动Mini Pupper的SLAM节点


在你的PC上打开另一个终端，并执行以下命令启动SLAM节点，如图3.5.1：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_navigation slam.launch.py
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/c33dd835ca234302ac8e3ab008fec3fa.png)


这将启动Mini Pupper的SLAM过程，如图3.5.2。
![在这里插入图片描述](https://img-blog.csdnimg.cn/89d991f4ce6c44df9105d90700f9fd77.png)

## 第六步：控制Mini Pupper完成SLAM


使用任务2中学到的键盘控制方法，操控Mini Pupper在环境中移动。让它在房间里走动，直到地图显示完整。
 ![请添加图片描述](https://img-blog.csdnimg.cn/d90a084ee8d34a33a0c60fe550fc6998.gif)

## 第七步：保存SLAM地图


当你认为地图已经足够完整时，执行以下命令保存地图：

```bash
ros2 service call /finish_trajectory cartographer_ros_msgs/srv/FinishTrajectory "{trajectory_id: 0}"
ros2 service call /write_state cartographer_ros_msgs/srv/WriteState "{filename: '${HOME}/mymap.pbstream'}"
ros2 run nav2_map_server map_saver_cli -f ${HOME}/mymap
```
![请添加图片描述](https://img-blog.csdnimg.cn/a1c7486106bc4c06883fea28401dda7a.jpeg)


如图3.7.1，这将把地图保存到你的PC上。

<span id="step4"></span>

# 任务4：Mini Pupper在真实世界的导航


在这个任务中，我们将学习如何让Mini Pupper在真实世界中进行导航。这个任务包括七个步骤：

## 第一步：检查PC和Mini Pupper上的Ubuntu22.04和ROS2 Humble的环境配置


确保你已经完成了任务1中的两个步骤，配置好了PC和Mini Pupper的环境。

## 第二步：SSH登录Mini Pupper


在你的PC上打开一个终端，并通过SSH登录到Mini Pupper。例如：

```bash
ssh username@mini-pupper-ip-address
```

请将`username`和`mini-pupper-ip-address`替换为实际的用户名和IP地址。

## 第三步：SSH启动Mini Pupper的bringup


在通过SSH登录到Mini Pupper的终端中，执行以下命令启动bringup：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_bringup bringup.launch.py
```

这将启动Mini Pupper上的所有必要节点。

## 第四步：替换地图文件


在任务3中创建的地图需要放置到`mini_pupper_navigation`包中的地图文件夹中。在你的PC上执行以下命令进行替换：

```bash
sudo cp ~/mymap.pgm ~/ros2_ws/src/mini_pupper_ros/mini_pupper_navigation/maps/mymap.pgm
sudo cp ~/mymap.pbstream ~/ros2_ws/src/mini_pupper_ros/mini_pupper_navigation/maps/mymap.pbstream
sudo cp ~/mymap.yaml ~/ros2_ws/src/mini_pupper_ros/mini_pupper_navigation/maps/mymap.yaml
```

请确保已经替换了上述文件，如果你不确定，你可以打开`mini_pupper_navigation`包中的地图文件夹确认是否有这个文件。

## 第五步：在PC上启动Mini Pupper的Localization节点


在你的PC上打开一个终端，并执行以下命令启动Localization节点：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_navigation localization.launch.py
```
![请添加图片描述](https://img-blog.csdnimg.cn/2b63b329903d44f7b163ca47e61eba66.png)


如图4.6.1，这将启动Mini Pupper的定位过程。

## 第六步：在PC上启动Mini Pupper的Navigation节点


在你的PC上打开另一个终端，并执行以下命令启动Navigation节点：

```bash
. ~/ros2_ws/install/setup.bash
ros2 launch mini_pupper_navigation navigation.launch.py
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/89b6acecb1254632962a54f9d48a116e.png)

如图4.7.1，这将启动Mini Pupper的导航过程。

## 第七步：在Rviz中用2D Goal Pose发布要去的位置


现在，你可以在Rviz中为Mini Pupper设置目标点。在Rviz窗口中选择"2D Goal Pose"工具，然后在地图上单击并拖动以设置目标位置和方向。Mini Pupper将自动规划路径并导航到指定的目标位置。
![请添加图片描述](https://img-blog.csdnimg.cn/aa972addd02844b38f91f5737080a2b4.gif)

# 总结
| 知识点 | 内容 | 了解 | 熟悉 | 掌握 |
| --- | --- | --- | --- | --- |
| PC和Mini Pupper环境配置 | 配置环境并确保PC和Mini Pupper之间的通信 |  | ✔ |  |
| Mini Pupper控制 | 用键盘控制Mini Pupper移动 |  | ✔ |  |
| SLAM | 使用SLAM生成地图并保存 |  |  | ✔ |
| 导航 | 让Mini Pupper根据SLAM生成的地图进行导航 |  |  | ✔ |


假设您已经完成了本教程中的所有任务，并成功地掌握了Mini Pupper在实际环境中的控制、SLAM和导航。那么，您已经具备了处理实际机器人控制和导航任务所需的基本知识和技能。此外，本教程涉及的许多概念和工具（如ROS、Rviz等）也是机器人控制和仿真领域中的核心技术和工具。因此，您可以将这些知识和技能应用于其他机器人项目和任务中，进一步提高自己在机器人领域的专业技能和水平。同时，您也可以参考本教程中提到的资源和背景信息，继续学习和深入了解机器人控制和仿真的相关知识。
# 背景信息和资源


本教程基于以下资源编写：

*   [Ubuntu官网](https://ubuntu.com/)：Ubuntu是一种流行的Linux操作系统，本课程需要使用Ubuntu 22.04版本。
*   [ROS官网](https://www.ros.org/)：ROS是机器人领域中的一个流行的软件平台，本课程需要使用ROS2 Humble版本。
*   [Rviz官方用户指南](http://wiki.ros.org/rviz/UserGuide)：Rviz是ROS下的3D可视化工具，本课程中需要使用Rviz进行可视化操作。

*   [ROS Answers](https://answers.ros.org/questions/)：ROS Answers是ROS社区提供的一个问答平台，您可以在这里搜索和提交有关ROS的问题。
*   [Mini Pupper在GitHub上的源代码和README](https://github.com/mangdangroboticsclub/mini_pupper_ros/tree/ros2)：这个GitHub存储库包含Mini Pupper机器人的ROS2源代码和其他资源。
如果你不清楚教程的一些步骤，你也可以参考源代码仓库的README。

**版权信息：教材尚未完善，此处预留版权信息处理方式**
mini pupper相关内容可访问：[https://github.com/mangdangroboticsclub](https://github.com/mangdangroboticsclub)











